<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

  <!-- 1. КРИТИЧНО: Замените существующий индекс на vacancy_score -->
  <changeSet id="drop-old-vacancy-score-index" author="jb2">
    <dropIndex indexName="idx_vacancy_score_rating_vacancy"
               tableName="jb2_vacancy_score"/>
  </changeSet>

  <changeSet id="add-optimized-vacancy-score-index" author="jb2">
    <createIndex indexName="idx_vacancy_score_vacancy_rating"
                 tableName="jb2_vacancy_score">
      <column name="vacancy_id"/>
      <column name="rating"/>
    </createIndex>
  </changeSet>

  <!-- 2. КРИТИЧНО: Частичный индекс для неархивных вакансий -->
  <changeSet id="add-partial-index-not-archived" author="jb2">
    <sql>
      CREATE INDEX idx_vacancy_not_archived_published
        ON jb2_vacancy(published_at DESC, id)
        WHERE archived = false;
    </sql>
  </changeSet>

  <!-- 3. Covering индекс для vacancy_info со статусом -->
  <changeSet id="add-index-vacancy-info-status" author="jb2">
    <createIndex indexName="idx_vacancy_info_id_status"
                 tableName="jb2_vacancy_info">
      <column name="id"/>
      <column name="status"/>
    </createIndex>
  </changeSet>

  <!-- 4. Оптимизация для фильтра по totalScore -->
  <changeSet id="add-index-vacancy-score-total" author="jb2">
    <createIndex indexName="idx_vacancy_score_vacancy_total"
                 tableName="jb2_vacancy_score">
      <column name="vacancy_id"/>
      <column name="total_score"/>
    </createIndex>
  </changeSet>

  <!-- 5. Индекс для связи vacancy -> employer -->
  <changeSet id="add-index-vacancy-employer" author="jb2">
    <createIndex indexName="idx_vacancy_employer_id"
                 tableName="jb2_vacancy">
      <column name="employer_id"/>
    </createIndex>
  </changeSet>

  <!-- 6. Частичный индекс для популярных рейтингов (опционально) -->
  <changeSet id="add-partial-index-good-ratings" author="jb2">
    <sql>
      CREATE INDEX idx_vacancy_score_good_ratings
        ON jb2_vacancy_score(vacancy_id)
        WHERE rating IN ('EXCELLENT', 'GOOD', 'MODERATE');
    </sql>
  </changeSet>

</databaseChangeLog>