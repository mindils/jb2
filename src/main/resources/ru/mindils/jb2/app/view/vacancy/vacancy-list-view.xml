<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<view xmlns="http://jmix.io/schema/flowui/view"
      xmlns:c="http://jmix.io/schema/flowui/jpql-condition"
      title="msg://vacancyListView.title"
      focusComponent="vacanciesDataGrid">
  <data>
    <collection id="vacanciesDc"
                class="ru.mindils.jb2.app.entity.Vacancy">
      <fetchPlan extends="_base">
        <property name="employer" fetchPlan="_base">
          <property name="employerInfo" fetchPlan="_base">
          </property>
        </property>
        <property name="vacancyInfo" fetchPlan="_base" fetch="JOIN"/>
        <property name="vacancyScore" fetchPlan="_base">
        </property>
      </fetchPlan>
      <loader id="vacanciesDl" readOnly="true">
        <query>
          <![CDATA[select e from jb2_Vacancy e order by e.publishedAt desc]]>
        </query>
      </loader>
    </collection>
  </data>
  <facets>
    <dataLoadCoordinator auto="true"/>
    <urlQueryParameters>
      <pagination component="pagination"/>
      <propertyFilter component="idFilter" param="id"/>
      <propertyFilter component="archFilter" param="archived"/>
    </urlQueryParameters>
  </facets>
  <actions>
    <action id="selectAction" type="lookup_select"/>
    <action id="discardAction" type="lookup_discard"/>
  </actions>
  <layout>
    <!-- Адаптивный контейнер - одна линия на десктопе, перенос на мобильных -->
    <hbox width="100%"
          css="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-start; margin-bottom: 1rem;">

      <!-- Фильтры -->
      <details summaryText="Фильтры"
               themeNames="small"
               css="flex: 1 1 auto; min-width: 300px;">
        <hbox css="display: flex; flex-wrap: wrap; gap: 0.5rem;">
          <propertyFilter
              id="idFilter"
              label="ИД Вакансии"
              property="id"
              operation="EQUAL"
              dataLoader="vacanciesDl"
              labelPosition="TOP"
              css="flex: 1 1 180px; min-width: 120px;"
          />

          <jpqlFilter id="javaFilter"
                      dataLoader="vacanciesDl"
                      defaultValue="true"
                      label="Java Вакансия"
                      labelPosition="TOP"
                      parameterClass="java.lang.Boolean"
                      parameterName="javaParam"
                      css="flex: 1 1 180px; min-width: 120px;">
            <condition>
              <c:jpql>
                <c:join><![CDATA[
                  join jb2_VacancyLlmAnalysis vla on vla.vacancy = {E}
                ]]>
                </c:join>
                <c:where><![CDATA[
                  vla.analyzeType = 'JAVA_PRIMARY'
                  and cast(function('jsonb_extract_path_text', vla.analyzeData, 'java') boolean) = :javaParam
                ]]>
                </c:where>
              </c:jpql>
            </condition>
          </jpqlFilter>

          <propertyFilter
              id="archFilter"
              label="Архив"
              property="archived"
              operation="EQUAL"
              dataLoader="vacanciesDl"
              labelPosition="TOP"
              defaultValue="false"
              css="flex: 1 1 180px; min-width: 120px;"
          />

          <propertyFilter
              property="vacancyScore.rating"
              operation="IN_LIST"
              dataLoader="vacanciesDl"
              label="Рейтинг"
              labelPosition="TOP"
              defaultValue="EXCELLENT,GOOD,MODERATE"
              css="flex: 1 1 180px; min-width: 120px;">
            <multiSelectComboBox itemsEnum="ru.mindils.jb2.app.entity.VacancyScoreRating"/>
          </propertyFilter>

          <propertyFilter
              property="vacancyInfo.status"
              operation="IN_LIST"
              dataLoader="vacanciesDl"
              label="Мой статус"
              labelPosition="TOP"
              css="flex: 1 1 180px; min-width: 120px;">
            <multiSelectComboBox itemsEnum="ru.mindils.jb2.app.entity.VacancyStatus"/>
          </propertyFilter>

          <propertyFilter
              label="Оценка ≥"
              property="vacancyScore.totalScore"
              operation="GREATER_OR_EQUAL"
              dataLoader="vacanciesDl"
              labelPosition="TOP"
              css="flex: 1 1 180px; min-width: 120px;"
          />

          <jpqlFilter id="noStatusFilter"
                      dataLoader="vacanciesDl"
                      label="Без статуса"
                      labelPosition="TOP"
                      parameterClass="java.lang.Boolean"
                      parameterName="noStatus"
                      css="flex: 1 1 180px; min-width: 120px;">
            <condition>
              <c:jpql>
                <c:where><![CDATA[
                  (:noStatus = false or e.vacancyInfo is null)
                ]]>
                </c:where>
              </c:jpql>
            </condition>
            <checkbox/>
          </jpqlFilter>
        </hbox>
      </details>

      <!-- Кнопка добавления в очередь -->
      <dropdownButton id="vacancyDropdown"
                      text="Добавить в очередь"
                      icon="CALC"
                      css="flex: 0 0 auto; min-width: 200px;">
        <items>
          <textItem id="updateVacancyBtn" text="Обновление"/>
          <textItem id="addVacancyInFirstLlmQueueBtn" text="Первичный анализ llm"/>
          <textItem id="addVacancyInSocialLlmQueueBtn" text="Полный анализ llm"/>
          <textItem id="calculateVacancyScoresBtn" text="Рассчитать оценки"/>
        </items>
      </dropdownButton>

      <!-- Пагинация -->
      <simplePagination id="pagination"
                        dataLoader="vacanciesDl"
                        css="flex: 0 0 auto;"/>
    </hbox>

    <!-- Таблица -->
    <dataGrid id="vacanciesDataGrid"
              width="100%"
              minHeight="20em"
              dataContainer="vacanciesDc"
              columnReorderingAllowed="true"
              themeNames="compact">
      <actions>
        <action id="readAction" type="list_read" text="Посмотреть">
          <properties>
            <property name="openMode" value="DIALOG"/>
          </properties>
        </action>
      </actions>
      <columns resizable="true">
        <column property="id" autoWidth="true"/>
        <column property="name" autoWidth="true"/>
        <column property="vacancyInfo.status" autoWidth="true"/>
        <column property="employer.name" autoWidth="true"/>
        <column property="keySkillsStr" width="20em"/>
        <column property="vacancyScore.totalScore" autoWidth="true"/>
        <column property="vacancyScore.rating" autoWidth="true"/>
        <column property="vacancyScore.negativeDescription"/>
        <column property="vacancyScore.positiveDescription"/>
        <column property="description"/>
        <column property="city" autoWidth="true"/>
        <column property="salary" autoWidth="true"/>
        <column property="metro" autoWidth="true"/>
        <column property="professionalRolesStr" autoWidth="true"/>
        <column property="workFormatStr" autoWidth="true"/>
        <column property="archived" autoWidth="true"/>
        <column property="hidden" autoWidth="true"/>
        <column property="alternateUrl" autoWidth="true"/>
        <column property="publishedAt" autoWidth="true"/>
        <column property="createdAt" autoWidth="true"/>
        <column property="initialCreatedAt" autoWidth="true"/>
        <column property="updatedAt" autoWidth="true"/>
      </columns>
      <contextMenu>
        <item id="updateVacancyMenu" text="Обновить вакансию"/>
        <item id="firstLlmAnalyseMenu" text="Первичный анализ"/>
        <item id="fullLlmAnalyseMenu" text="Полный анализ"/>
        <item id="vacancyScoreCalculateMenu" text="Посчитать оценку"/>
      </contextMenu>
    </dataGrid>

    <hbox id="lookupActions" visible="false">
      <button id="selectButton" action="selectAction"/>
      <button id="discardButton" action="discardAction"/>
    </hbox>
  </layout>
</view>