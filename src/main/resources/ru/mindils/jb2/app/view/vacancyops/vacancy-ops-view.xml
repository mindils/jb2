<?xml version="1.0" encoding="UTF-8"?>
<view xmlns="http://jmix.io/schema/flowui/view"
      xmlns:layout="http://jmix.io/schema/flowui/layout"
      title="msg://ru.mindils.jb2.app.view.vacancyops/vacancyOpsView.title">

  <data>
    <collection id="workflowInfosDc" class="ru.mindils.jb2.app.dto.WorkflowInfo">
      <!-- FIX #1: id лоадера -->
      <loader id="workflowInfosDl" readOnly="true"/>
      <fetchPlan extends="_base"/>
    </collection>
  </data>

  <layout>
    <vbox spacing="true" padding="true" width="100%">

      <!-- ===== TOP: Stats tiles ===== -->
      <h3 text="Операции с вакансиями"/>
      <hbox width="100%" classNames="gap-m" wrap="true">

        <vbox classNames="stat-card" themeNames="spacing" width="16rem">
          <h4 text="Очередь обновления"/>
          <p id="updateQueueCountText" classNames="stat-number"/>
          <button id="updateFromQueueBtn" text="Обновить из очереди"/>
        </vbox>

        <vbox classNames="stat-card" themeNames="spacing" width="24rem">
          <h4 text="Последняя синхронизация"/>
          <p id="lastSyncText"/>

          <button id="syncAllBtn" text="Полная синхронизация вакансий" themeNames="primary small"/>

          <textField id="daysField" label="Дней (1..30, пусто = авто(последнее обновление))" clearButtonVisible="true" width="14rem"/>
          <button id="syncRecentBtn" text="Синхронизация за период" themeName="small"/>
        </vbox>
      </hbox>

      <h3 text="Операции с анализом"/>
      <hbox width="100%" classNames="gap-m" wrap="true">

        <vbox classNames="stat-card" themeNames="spacing" width="16rem">
          <h4 text="Очередь первичного анализа"/>
          <p id="primaryQueueCountText" classNames="stat-number"/>
          <hbox>
            <button id="enqueueFirstChainBtn"
                    icon="PLUS" themeNames="icon" title="Добавить необработанные вакансии"/>

            <button id="analyzePrimaryBtn" icon="lumo:play" title="Запустить обработку"/>
          </hbox>
        </vbox>

        <vbox classNames="stat-card" themeNames="spacing" width="16rem">
          <h4 text="Очередь Полный "/>
          <p id="fullQueueCountText" classNames="stat-number"/>
          <hbox>
            <button id="enqueueFullChainBtn"
                    icon="PLUS" themeNames="icon" title="Добавить необработанные вакансии"/>
            <button id="analyzeFullBtn" icon="lumo:play" title="Запустить обработку"/>
          </hbox>
        </vbox>
        <vbox classNames="stat-card" themeNames="spacing" width="16rem">
          <h4 text="Рейтинг вакансий"/>
          <button id="calculateScoreBtn" icon="lumo:play" text="Пересчитать рейтинг"/>
        </vbox>
      </hbox>
      <!-- ===== Quick actions ===== -->
      <!-- FIX #2: enum пишется UPPERCASE -->
      <hbox width="100%" classNames="gap-s" alignItems="END" wrap="true">
        <button id="analyzeSocialBtn" text="Анализ вакансий (социальный)"/>
        <button id="refreshBtn" text="Обновить"/>
      </hbox>

      <!-- ===== Active workflows ===== -->
      <h3 id="workflowStatusHeader" text="Запущенные процессы"/>
      <dataGrid id="workflowInfosDataGrid"
                dataContainer="workflowInfosDc"
                width="100%" allRowsVisible="true">
        <columns>
          <column property="description" header="msg://ru.mindils.jb2.app.view.vacancyops/workflowGrid.description" autoWidth="true"/>
          <column property="status" header="msg://ru.mindils.jb2.app.view.vacancyops/workflowGrid.status" width="10em"/>
          <column property="startTime" header="msg://ru.mindils.jb2.app.view.vacancyops/workflowGrid.startTime" width="16em"/>
          <column property="workflowId" header="msg://ru.mindils.jb2.app.view.vacancyops/workflowGrid.workflowId" width="20em"/>
        </columns>
      </dataGrid>

      <!-- ===== Advanced actions (collapsed) ===== -->
      <details summaryText="Дополнительно" opened="false">
        <hbox classNames="gap-s" wrap="true">
          <button id="enqueueNotAnalyzedBtn" text="Добавить все без анализа (PRIMARY)"/>
          <button id="enqueuePrimaryAllBtn" text="Добавить все вакансии (PRIMARY)"/>
          <button id="enqueueSocialJavaBtn" text="Добавить Java-вакансии (SOCIAL)"/>
        </hbox>
      </details>

    </vbox>

    <hbox id="chainAnalysisGroup" caption="Цепочки анализа">
      <vbox spacing="true">
        <!-- Статистика цепочек -->
        <hbox spacing="true">
          <vbox>
            <span text="msg://fullChainQueueCountText.text"/>
            <p id="fullChainQueueCountText" text="0" classNames="text-lg font-semibold"/>
          </vbox>
          <vbox>
            <span text="msg://primaryChainQueueCountText.text"/>
            <p id="primaryChainQueueCountText" text="0" classNames="text-lg font-semibold"/>
          </vbox>
          <vbox>
            <span text="msg://socialTechnicalChainQueueCountText.text"/>
            <p id="socialTechnicalChainQueueCountText" text="0" classNames="text-lg font-semibold"/>
          </vbox>
        </hbox>

        <!-- Кнопки запуска цепочек -->
        <hbox spacing="true">
          <button id="startFullChainBtn"
                  text="msg://startFullChainBtn.text"
                  icon="PLAY"
                  variant="PRIMARY"/>
          <button id="startPrimaryChainBtn"
                  text="msg://startPrimaryChainBtn.text"
                  icon="PLAY"/>
          <button id="startSocialTechnicalChainBtn"
                  text="msg://startSocialTechnicalChainBtn.text"
                  icon="PLAY"/>
        </hbox>

        <!-- Кнопки управления очередями -->
        <hbox spacing="true">
          <button id="enqueueJavaFullChainBtn"
                  text="msg://enqueueJavaFullChainBtn.text"
                  icon="PLUS"/>
        </hbox>
      </vbox>
    </hbox>
  </layout>
</view>
